<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>下一班校车</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            morandiBg: '#f6f1eb',
            morandiCard: '#f0e3d8',
            morandiPrimary: '#d9a79c',
            morandiPrimaryDark: '#b17b6b',
            morandiAccent: '#e0c097',
            morandiText: '#59423b',
            morandiMuted: '#a48b7a'
          }
        }
      }
    }
  </script>
</head>
<body class="min-h-screen bg-morandiBg flex items-center justify-center px-4">
  <div class="w-full max-w-md bg-morandiCard rounded-3xl shadow-lg p-6 sm:p-7">
    <h1 class="text-3xl font-semibold text-morandiText text-center mb-6 tracking-wide">
      下一班校车
    </h1>

    <!-- 结果展示 -->
    <div class="bg-white/80 rounded-2xl p-6 mb-4 border border-white/60 text-center">
      <p class="text-sm text-morandiMuted mb-2">
        当前时间：<span id="current-time">--:--</span>
      </p>
      
      <p id="next-bus-text"
         class="text-5xl font-bold tracking-wider text-morandiPrimaryDark mb-2">
        --:--
      </p>
      
      <p id="extra-tip" class="text-sm text-morandiMuted"></p>
      
      <p class="text-xs text-morandiMuted mt-3">
        <span id="current-station-label">如意公寓</span> · <span id="current-daytype-label">工作日</span>
      </p>
    </div>

    <p class="text-s text-center text-morandiMuted leading-relaxed">Lei ♥ Hani</p>
  </div>

  <script>
    // 时刻表配置
    const timetableConfig = {
      // 如意公寓 → 道远楼东
      ruyi: {
        workday: [
          "07:10","07:40",
          "08:00","08:15","08:30","09:00",
          "09:10","10:10","11:10","12:10",
          "13:00","13:10","13:30","14:00",
          "14:10","15:10","16:10","17:10",
          "18:00","18:15","18:30","19:00",
          "19:10","20:10","21:10","22:10"
        ],
        weekend: [
          "07:10","07:40","08:40","09:40",
          "10:40","11:40","12:40","13:40",
          "14:40","15:40","16:40","17:40",
          "18:40","19:40","20:40","21:40",
          "22:40"
        ]
      },
      // 道远楼东 → 如意公寓
      daoyuan: {
        workday: [
          "08:00","08:30","09:00","09:30",
          "10:00","10:30","11:00","11:30",
          "12:00","12:15","12:30","12:45",
          "13:00","13:30","14:00","14:30",
          "15:00","15:30","16:00","16:30",
          "17:00","17:15","17:30","17:45",
          "18:00","18:30","19:00","19:30",
          "20:00","20:30","21:00","21:15",
          "21:30","21:45","22:00","22:30",
          "23:00"
        ],
        weekend: [
          "08:00","09:00","10:00","11:00",
          "12:00","13:00","14:00","15:00",
          "16:00","17:00","18:00","19:00",
          "20:00","21:00","22:00","23:00"
        ]
      }
    };

    // 当前状态
    let currentStation = "ruyi";
    let currentDayType = "workday";
    let dayTypeCode = 0; // API返回的具体类型

    function getBeijingTime() {
      const now = new Date();
      return new Intl.DateTimeFormat('zh-CN', {
        timeZone: 'Asia/Shanghai',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      }).format(now);
    }

    function timeToMinutes(timeStr) {
      const [h, m] = timeStr.split(":").map(Number);
      return h * 60 + m;
    }

    function getCurrentMinutes() {
      const [h, m] = getBeijingTime().split(":").map(Number);
      return h * 60 + m;
    }

    function getBeijingDate() {
      const now = new Date();
      // 使用北京时间格式化日期
      const beijingDate = new Intl.DateTimeFormat('sv-SE', {
        timeZone: 'Asia/Shanghai'
      }).format(now);
      return beijingDate; // 返回 YYYY-MM-DD 格式
    }

    // 自动判断是否为节假日
    async function checkHoliday() {
      try {
        const today = getBeijingDate();
        console.log("API调用 - 查询日期:", today);
        const response = await fetch(`https://timor.tech/api/holiday/info/${today}`);
        const data = await response.json();
        console.log("API调用 - 返回数据:", data);
        console.log("API调用 - 日期类型:", data.type.type, "含义: 0=工作日 1=周末 2=节假日 3=调休补班");
        
        // 保存具体的日期类型代码
        dayTypeCode = data.type.type;
        console.log("API调用 - 保存dayTypeCode:", dayTypeCode);
        
        // 只有周末(1)和节假日(2)使用weekend时间表
        // 工作日(0)和调休补班(3)使用workday时间表
        const isWeekendOrHoliday = data.type.type === 1 || data.type.type === 2;
        console.log("API调用 - 使用时间表:", isWeekendOrHoliday ? "weekend" : "workday");
        
        return isWeekendOrHoliday;
      } catch (error) {
        alert("节假日查询API不可用，将按工作日计算");
        return false;
      }
    }



    // 获取当前位置
    function getCurrentLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error("浏览器不支持地理定位"));
          return;
        }

        navigator.geolocation.getCurrentPosition(
          position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            console.log("定位成功！当前位置:", lat, lng);
            
            // 如意公寓和道远楼东的实际坐标
            const ruyiCoords = { lat: 22.704486, lng: 114.208642 }; 
            const daoyuanCoords = { lat: 22.686922, lng: 114.21231 }; 
            
            // 计算距离
            const distToRuyi = Math.sqrt(
              Math.pow(lat - ruyiCoords.lat, 2) + Math.pow(lng - ruyiCoords.lng, 2)
            );
            const distToDaoyuan = Math.sqrt(
              Math.pow(lat - daoyuanCoords.lat, 2) + Math.pow(lng - daoyuanCoords.lng, 2)
            );
            
            const nearestStation = distToRuyi <= distToDaoyuan ? "ruyi" : "daoyuan";
            console.log("最近站点:", nearestStation === "ruyi" ? "如意公寓" : "道远楼东");
            resolve(nearestStation);
          },
          error => {
            console.log("定位失败，错误代码:", error.code, "错误信息:", error.message);
            reject(new Error(`定位失败: ${error.code}`));
          },
          { 
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 300000
          }
        );
      });
    }



    // 计算下一班车
    function calcNextBus() {
      // 更新当前时间显示
      document.getElementById("current-time").textContent = getBeijingTime();

      const timetable = timetableConfig[currentStation][currentDayType];
      const nowMin = getCurrentMinutes();
      let nextBus = null;

      // 查找下一班车
      for (const time of timetable) {
        if (timeToMinutes(time) > nowMin) {
          nextBus = time;
          break;
        }
      }

      const nextBusEl = document.getElementById("next-bus-text");
      const tipEl = document.getElementById("extra-tip");

      if (nextBus) {
        nextBusEl.textContent = nextBus;
        const minutesLeft = timeToMinutes(nextBus) - nowMin;
        
        if (minutesLeft <= 2) {
          tipEl.textContent = "马上就要发车了！";
        } else if (minutesLeft <= 10) {
          tipEl.textContent = `${minutesLeft} 分钟后发车`;
        } else {
          tipEl.textContent = `还有 ${minutesLeft} 分钟`;
        }
      } else {
        nextBusEl.textContent = "无班次";
        tipEl.textContent = "今日班车已结束";
      }

      // 更新状态显示
      document.getElementById("current-station-label").textContent =
        currentStation === "ruyi" ? "如意公寓" : "道远楼东";
      
      // 根据API返回的具体类型显示正确的标签
      console.log("显示更新 - dayTypeCode:", dayTypeCode, "currentDayType:", currentDayType);
      let dayTypeLabel = "工作日";
      switch(dayTypeCode) {
        case 0:
          dayTypeLabel = "工作日";
          break;
        case 1:
          dayTypeLabel = "周末";
          break;
        case 2:
          dayTypeLabel = "节假日";
          break;
        case 3:
          dayTypeLabel = "调休补班";
          break;
        default:
          dayTypeLabel = currentDayType === "workday" ? "工作日" : "周末";
          console.log("显示更新 - 使用默认逻辑:", dayTypeLabel);
      }
      console.log("显示更新 - 最终标签:", dayTypeLabel);
      document.getElementById("current-daytype-label").textContent = dayTypeLabel;
    }

    // 初始化应用
    async function initApp() {
      try {
        // 获取位置信息
        const station = await getCurrentLocation();
        currentStation = station;
        
        // 获取节假日信息
        try {
          const isHoliday = await checkHoliday();
          currentDayType = isHoliday ? "weekend" : "workday";
        } catch (error) {
          currentDayType = "workday";
        }
        
        // 计算并显示班车信息
        calcNextBus();
        
        // 每分钟更新一次班车信息
        setInterval(calcNextBus, 60 * 1000);
        
        // 每10分钟重新定位一次，确保位置准确
        setInterval(async () => {
          try {
            const newStation = await getCurrentLocation();
            if (newStation !== currentStation) {
              console.log("位置发生变化:", currentStation === "ruyi" ? "如意公寓" : "道远楼东", "->", newStation === "ruyi" ? "如意公寓" : "道远楼东");
              currentStation = newStation;
              calcNextBus();
            } else {
              console.log("定期定位确认，位置未变化:", currentStation === "ruyi" ? "如意公寓" : "道远楼东");
            }
          } catch (error) {
            console.log("定期定位失败，保持当前站点");
          }
        }, 10 * 60 * 1000);
        
      } catch (error) {
        console.log("定位失败，使用默认站点");
        currentStation = "ruyi";
        currentDayType = "workday";
        calcNextBus();
        setInterval(calcNextBus, 60 * 1000);
      }
    }

    // 如果想完全禁用地理定位，可以使用这个简化版本：
    // async function initApp() {
    //   try {
    //     const isHoliday = await checkHoliday();
    //     currentDayType = isHoliday ? "weekend" : "workday";
    //   } catch (error) {
    //     currentDayType = "workday";
    //   }
    //   calcNextBus();
    //   setInterval(calcNextBus, 60 * 1000);
    // }

    // 页面加载完成后执行
    window.addEventListener("DOMContentLoaded", initApp);
  </script>
</body>
</html>